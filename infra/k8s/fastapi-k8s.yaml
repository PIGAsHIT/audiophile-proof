apiVersion: apps/v1
kind: Deployment
metadata:
  name: fastapi-backend
spec:
  replicas: 2 
  selector:
    matchLabels:
      app: fastapi
  template:
    metadata:
      labels:
        app: fastapi
    spec:
      containers:
      - name: fastapi
        image: pigashit/audiophile-backend:latest  # ğŸ‘ˆ å»ºè­°æ”¹ latestï¼Œé… Actions è‡ªå‹•åŒ–
        ports:
        - containerPort: 8000
        env:
        # --- å¾ Secret è®€å– (Key å…¨éƒ¨å°é½Šä½ çš„ .env è®Šæ•¸å) ---
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: audiophile-secrets
              key: DB_USER
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: audiophile-secrets
              key: DB_PASSWORD
        - name: DB_NAME
          valueFrom:
            secretKeyRef:
              name: audiophile-secrets
              key: DB_NAME
        - name: GEMINI_API_KEY
          valueFrom:
            secretKeyRef:
              name: audiophile-secrets
              key: GEMINI_API_KEY
        - name: SPOTIFY_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: audiophile-secrets
              key: SPOTIFY_CLIENT_ID
        - name: SPOTIFY_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: audiophile-secrets
              key: SPOTIFY_CLIENT_SECRET
        - name: SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: audiophile-secrets
              key: SECRET_KEY

        # --- åŸºç¤è¨­æ–½é€£ç·š (ä¿®æ­£ç‚º K8s Service åç¨±) ---
        - name: DB_HOST
          value: "postgres-db"     # ğŸ‘ˆ æ ¹æ“šä½ ä¹‹å‰çš„ pods åˆ—è¡¨ï¼Œåå­—æ‡‰è©²æ˜¯é€™å€‹
        - name: DB_PORT
          value: "5432"
        - name: REDIS_HOST
          value: "redis-db"        # ğŸ‘ˆ æ ¹æ“šä½ ä¹‹å‰çš„ pods åˆ—è¡¨åç¨±
        - name: REDIS_PORT
          value: "6379"
        - name: MONGO_HOST
          value: "mongodb"         # ğŸ‘ˆ æ ¹æ“šä½ ä¹‹å‰çš„ pods åˆ—è¡¨åç¨±
        - name: MONGO_PORT
          value: "27017"
        
        # --- å…¶ä»–è¨­å®š ---
        - name: ALGORITHM
          value: "HS256"
        - name: ACCESS_TOKEN_EXPIRE_MINUTES
          value: "30"
        - name: SPOTIFY_REDIRECT_URI
          value: "http://fastapi-service/callback"

        # --- å¥åº·æª¢æŸ¥ ---
        livenessProbe: 
          httpGet:
            path: /health 
            port: 8000
          initialDelaySeconds: 60  # çµ¦å¤šä¸€é»æ™‚é–“å•Ÿå‹•ï¼Œé¿å…é€£è³‡æ–™åº«å¤ªæ…¢è¢« K8s ç æ‰
          periodSeconds: 15
---
apiVersion: v1
kind: Service
metadata:
  name: fastapi-service
spec:
  selector:
    app: fastapi
  ports:
    - protocol: TCP
      port: 80 
      targetPort: 8000
  type: LoadBalancer