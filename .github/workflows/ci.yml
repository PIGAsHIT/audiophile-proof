name: Audiophile CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # --- ç¬¬ä¸€éšæ®µï¼šåŸ·è¡Œæ¸¬è©¦ (CI) ---
  test:
    runs-on: ubuntu-latest

    # ğŸŸ¢ é—œéµä¿®æ”¹ï¼šä¸€æ¬¡å•Ÿå‹•ä¸‰å€‹æœå‹™ (Postgres, Redis, Mongo)
    services:
      # 1. PostgreSQL
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        # å¥åº·æª¢æŸ¥ï¼šç­‰ DB æº–å‚™å¥½å†è·‘æ¸¬è©¦
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      # 2. Redis
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      # 3. MongoDB
      mongo:
        image: mongo:6
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: secret_mongo
        ports:
          - 27017:27017
        # Mongo 6 çš„å¥åº·æª¢æŸ¥æ¯”è¼ƒé¾œæ¯›ï¼Œé€™è£¡ç”¨ mongosh ping
        options: >-
          --health-cmd "echo 'db.runCommand(\"ping\").ok' | mongosh localhost:27017/test --quiet"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # å®‰è£å°ˆæ¡ˆä¾è³´ + æ¸¬è©¦å·¥å…· + è³‡æ–™åº«é©…å‹•
          pip install -r requirements.txt
          pip install pytest httpx psycopg2-binary motor redis

      - name: Run Tests
        # ğŸŸ¢ è¨­å®šç’°å¢ƒè®Šæ•¸è®“ Python é€£åˆ°ä¸Šé¢çš„ Service
        env:
          # Postgres è¨­å®š
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
          POSTGRES_SERVER: localhost
          POSTGRES_PORT: 5432
          POSTGRES_DB: test_db
          
          # Mongo è¨­å®š (å¸³å¯†è¦è·Ÿä¸Šé¢ mongo service ä¸€æ¨£)
          MONGO_USER: admin
          MONGO_PASSWORD: secret_mongo
          MONGO_HOST: localhost
          MONGO_PORT: 27017
          
          # Redis è¨­å®š
          REDIS_HOST: localhost
          
          # å…¶ä»–
          SECRET_KEY: supersecretkeytesting
        run: |
          python -m pytest

  # --- ç¬¬äºŒéšæ®µï¼šæ‰“åŒ…ä¸¦ä¸Šå‚³ Docker Hub (CD) ---
  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          # âš ï¸ è¨˜å¾—æ”¹å›ä½ çš„ Docker Hub å¸³è™Ÿ
          tags: yourusername/audiophile-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max