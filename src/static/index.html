<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audiophile Proof</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .gold-gradient {
            background: linear-gradient(135deg, #d4af37 0%, #a88426 100%);
        }

        .gold-text {
            background: linear-gradient(to right, #fcd34d, #d97706);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="bg-[#121212] text-gray-200 min-h-screen flex flex-col items-center py-10 font-sans">

    <div class="w-full max-w-lg px-4 relative">
        <h1 class="text-4xl font-extrabold text-center mb-8 tracking-widest uppercase">
            <span class="gold-text">Audiophile</span> <span class="text-gray-600 text-2xl">Proof</span>
        </h1>

        <div id="nav-bar"
            class="hidden flex justify-center space-x-6 mb-8 text-sm uppercase tracking-wide border-b border-gray-800 pb-4">
            <button onclick="switchTab('search')" id="nav-search"
                class="text-amber-500 font-bold transition">Search</button>
            <button onclick="switchTab('history')" id="nav-history"
                class="text-gray-500 hover:text-amber-500 transition">History</button>
            <button onclick="switchTab('collection')" id="nav-collection"
                class="text-gray-500 hover:text-amber-500 transition">Collection</button>
            <button onclick="logout()" class="text-gray-600 hover:text-red-500 transition ml-4"><i
                    class="fas fa-sign-out-alt"></i></button>
        </div>

        <div id="auth-section" class="bg-[#1e1e1e] border border-gray-800 p-8 shadow-2xl mb-6">
            <h2 id="auth-title" class="text-xl font-light text-amber-500 mb-6 tracking-widest text-center">LOGIN</h2>
            <input type="email" id="email" placeholder="Email"
                class="w-full bg-[#121212] border border-gray-700 p-3 mb-3 text-white focus:border-amber-500 focus:outline-none">
            <input type="password" id="password" placeholder="Password"
                class="w-full bg-[#121212] border border-gray-700 p-3 mb-6 text-white focus:border-amber-500 focus:outline-none">
            <button onclick="handleAuth()" id="auth-btn"
                class="w-full gold-gradient text-black font-bold py-3 uppercase tracking-wider hover:opacity-90 transition">Login</button>
            <p onclick="toggleAuthMode()" id="toggle-text"
                class="text-center text-xs text-gray-500 mt-4 cursor-pointer hover:text-amber-500 transition">Create an
                Account</p>
        </div>

        <div id="search-view" class="hidden fade-in">
            <div class="bg-[#1e1e1e] border border-gray-800 p-6 shadow-xl mb-6">
                <div class="flex space-x-2 mb-4">
                    <input type="text" id="brand" placeholder="Brand"
                        class="w-1/2 bg-[#121212] border border-gray-700 p-3 text-white focus:border-amber-500 focus:outline-none">
                    <input type="text" id="model" placeholder="Model"
                        class="w-1/2 bg-[#121212] border border-gray-700 p-3 text-white focus:border-amber-500 focus:outline-none">
                </div>
                <button onclick="getRecommendation()" id="search-btn"
                    class="w-full border border-amber-600 text-amber-500 py-3 font-bold uppercase tracking-widest hover:bg-amber-600 hover:text-black transition">
                    Analyze
                </button>
            </div>

            <div id="result-card" class="hidden bg-[#1e1e1e] border-t-4 border-amber-600 shadow-2xl relative fade-in">
                <div class="relative">
                    <img id="album-cover" src="" class="w-full h-80 object-cover opacity-80">
                    <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-[#1e1e1e] to-transparent h-32">
                    </div>
                    <button onclick="toggleFavorite()" id="fav-btn"
                        class="absolute top-4 right-4 bg-black/50 p-3 rounded-full text-2xl text-gray-400 hover:text-red-500 transition backdrop-blur-sm"><i
                            class="fas fa-heart"></i></button>
                </div>
                <div class="p-6 -mt-10 relative z-10">
                    <h2 id="song-title" class="text-3xl font-bold text-white mb-1">Title</h2>
                    <p id="artist-name" class="text-amber-500 text-lg mb-6 tracking-wide">Artist</p>
                    <div class="space-y-4 mb-8">
                        <div class="border-l-2 border-amber-600 pl-4">
                            <h3 class="text-xs text-gray-500 uppercase">Bass</h3>
                            <p id="an-bass" class="text-sm text-gray-300">...</p>
                        </div>
                        <div class="border-l-2 border-amber-600 pl-4">
                            <h3 class="text-xs text-gray-500 uppercase">Mids</h3>
                            <p id="an-mids" class="text-sm text-gray-300">...</p>
                        </div>
                        <div class="border-l-2 border-amber-600 pl-4">
                            <h3 class="text-xs text-gray-500 uppercase">Highs</h3>
                            <p id="an-highs" class="text-sm text-gray-300">...</p>
                        </div>
                    </div>
                    <div class="bg-[#121212] p-4 border border-gray-800 rounded mb-6">
                        <h3 class="text-amber-500 text-xs uppercase font-bold mb-2">Listening Guide</h3>
                        <p id="an-guide" class="text-sm text-gray-400 leading-relaxed">...</p>
                    </div>
                    <div class="flex flex-wrap gap-2 text-xs text-gray-600 mb-6 font-mono">
                        <span id="spec-driver" class="border border-gray-800 px-2 py-1"></span>
                        <span id="spec-year" class="border border-gray-800 px-2 py-1"></span>
                    </div>
                    <a id="spotify-link" href="#" target="_blank"
                        class="block w-full bg-[#1DB954] hover:bg-[#1ed760] text-black font-bold py-4 text-center uppercase tracking-widest transition">Listen
                        on Spotify</a>
                </div>
            </div>
        </div>

        <div id="history-view" class="hidden fade-in w-full">
            <h2 class="text-xl font-light text-center mb-6 text-gray-400 tracking-widest">SEARCH HISTORY</h2>
            <div id="history-list" class="space-y-3">
            </div>
        </div>

        <div id="collection-view" class="hidden fade-in w-full">
            <h2 class="text-xl font-light text-center mb-6 text-amber-500 tracking-widest">COLLECTION</h2>
            <div id="fav-list" class="space-y-4"></div>
        </div>
    </div>

    <script>
        // ✅ 更有 Sense 的邏輯：改用 sessionStorage 並移除自動跳轉
        let currentToken = sessionStorage.getItem('token') || "";
        let currentTrackData = null;
        let isRegisterMode = false;
        let isFavorited = false;

        // ✅ 明確狀態管理：進入頁面一律顯示登入區塊，不主動呼叫 verifyTokenAndInit
        window.onload = () => {
            console.log("App Initialized. Please Login.");
        };

        async function verifyTokenAndInit() {
            if (!currentToken) return;
            try {
                const res = await fetch('/user/history', {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });

                if (res.ok) {
                    initApp();
                } else {
                    console.log("Session expired.");
                    logout();
                }
            } catch (e) {
                logout();
            }
        }

        function initApp() {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('nav-bar').classList.remove('hidden');
            switchTab('search');
        }

        function switchTab(tab) {
            ['search', 'history', 'collection'].forEach(t => {
                document.getElementById(`${t}-view`).classList.add('hidden');
                const btn = document.getElementById(`nav-${t}`);
                if (btn) {
                    btn.classList.remove('text-amber-500', 'font-bold');
                    btn.classList.add('text-gray-500');
                }
            });

            document.getElementById(`${tab}-view`).classList.remove('hidden');
            const activeBtn = document.getElementById(`nav-${tab}`);
            activeBtn.classList.remove('text-gray-500');
            activeBtn.classList.add('text-amber-500', 'font-bold');

            if (tab === 'collection') loadCollection();
            if (tab === 'history') loadHistory();
        }

        async function loadHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = '<p class="text-center text-gray-600">Loading history...</p>';
            try {
                const res = await fetch('/user/history', { headers: { 'Authorization': `Bearer ${currentToken}` } });
                const data = await res.json();
                list.innerHTML = '';
                if (data.length === 0) {
                    list.innerHTML = '<p class="text-center text-gray-600">No search history yet.</p>';
                    return;
                }
                data.forEach(item => {
                    list.innerHTML += `
                        <div onclick="restoreSearch('${item.brand}', '${item.model}')" class="bg-[#1e1e1e] p-4 border-l-4 border-gray-700 hover:border-amber-500 cursor-pointer transition group">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="text-gray-200 font-bold group-hover:text-amber-500 transition">${item.brand} ${item.model}</h3>
                                    <p class="text-xs text-gray-500">${item.timestamp}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs text-gray-400">Result: ${item.result_song}</p>
                                    <i class="fas fa-chevron-right text-gray-700 group-hover:text-amber-500 mt-1"></i>
                                </div>
                            </div>
                        </div>`;
                });
            } catch (e) { console.error(e); }
        }

        function restoreSearch(brand, model) {
            document.getElementById('brand').value = brand;
            document.getElementById('model').value = model;
            switchTab('search');
            getRecommendation();
        }

        async function loadCollection() {
            const list = document.getElementById('fav-list');
            list.innerHTML = 'Loading...';
            try {
                const res = await fetch('/user/favorites', { headers: { 'Authorization': `Bearer ${currentToken}` } });
                const data = await res.json();
                list.innerHTML = '';
                data.forEach(item => {
                    list.innerHTML += `
                        <div class="bg-[#1e1e1e] p-4 flex items-center space-x-4 border-b border-gray-800">
                            <img src="${item.cover_url}" class="w-12 h-12 object-cover opacity-70">
                            <div class="flex-1">
                                <h3 class="text-amber-500 font-bold">${item.title}</h3>
                                <p class="text-xs text-gray-500">${item.artist}</p>
                            </div>
                            <a href="${item.spotify_url}" target="_blank" class="text-[#1DB954] hover:text-white"><i class="fab fa-spotify text-xl"></i></a>
                            <button onclick="deleteFavorite('${item.track_id}')" class="text-gray-600 hover:text-red-500 ml-3"><i class="fas fa-trash"></i></button>
                        </div>`;
                });
            } catch (e) { }
        }

        async function handleAuth() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const endpoint = isRegisterMode ? '/auth/register' : '/auth/token';
            const body = isRegisterMode ? JSON.stringify({ email, password }) : new URLSearchParams({ username: email, password });
            const headers = isRegisterMode ? { 'Content-Type': 'application/json' } : { 'Content-Type': 'application/x-www-form-urlencoded' };
            try {
                const res = await fetch(endpoint, { method: 'POST', headers, body });
                const data = await res.json();
                if (res.ok) {
                    if (isRegisterMode) { alert("Success! Please Login."); toggleAuthMode(); }
                    else {
                        currentToken = data.access_token;
                        sessionStorage.setItem('token', currentToken); // ✅ 使用 sessionStorage
                        initApp();
                    }
                } else { alert(data.detail); }
            } catch (e) { alert(e); }
        }

        function toggleAuthMode() {
            isRegisterMode = !isRegisterMode;
            const btn = document.getElementById('auth-btn');
            const title = document.getElementById('auth-title');
            const toggleText = document.getElementById('toggle-text');
            if (isRegisterMode) {
                title.innerText = "REGISTER";
                btn.innerText = "Create Account";
                toggleText.innerText = "Already have an account? Login";
                btn.classList.remove('gold-gradient');
                btn.classList.add('bg-green-600', 'text-white');
            } else {
                title.innerText = "LOGIN";
                btn.innerText = "Login";
                toggleText.innerText = "Create an Account";
                btn.classList.remove('bg-green-600', 'text-white');
                btn.classList.add('gold-gradient');
            }
        }

        function logout() {
            sessionStorage.removeItem('token');
            location.reload();
        }

        async function getRecommendation() {
            const brand = document.getElementById('brand').value;
            const model = document.getElementById('model').value;
            const btn = document.getElementById('search-btn');
            if (!brand || !model) return;
            btn.innerHTML = 'Analyzing...'; btn.disabled = true;
            try {
                const res = await fetch('/recommend', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentToken}` }, body: JSON.stringify({ brand, model }) });
                const data = await res.json();
                currentTrackData = data;
                document.getElementById('album-cover').src = data.cover_url;
                document.getElementById('song-title').innerText = data.title;
                document.getElementById('artist-name').innerText = data.artist;
                document.getElementById('an-bass').innerText = data.analysis_bass;
                document.getElementById('an-mids').innerText = data.analysis_mids;
                document.getElementById('an-highs').innerText = data.analysis_highs;
                document.getElementById('an-guide').innerText = data.listening_guide;
                document.getElementById('spec-driver').innerText = data.driver_config;
                document.getElementById('spec-year').innerText = data.release_year;
                document.getElementById('spotify-link').href = data.spotify_url;
                await checkFavoriteStatus(data.track_id);
                document.getElementById('result-card').classList.remove('hidden');
            } catch (e) { alert("Error: " + e); }
            finally { btn.innerHTML = 'Analyze'; btn.disabled = false; }
        }

        async function deleteFavorite(id) {
            if (!confirm("Remove?")) return;
            await fetch(`/user/favorites/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${currentToken}` } });
            loadCollection();
        }

        async function checkFavoriteStatus(id) {
            try {
                const res = await fetch(`/user/favorites/check/${id}`, { headers: { 'Authorization': `Bearer ${currentToken}` } });
                const d = await res.json();
                isFavorited = d.is_favorited;
                updateFavBtn();
            } catch (e) { }
        }

        function updateFavBtn() {
            const btn = document.getElementById('fav-btn');
            btn.className = isFavorited ? "absolute top-4 right-4 bg-red-600 text-white p-3 rounded-full text-2xl transition shadow-lg shadow-red-900/50" : "absolute top-4 right-4 bg-black/50 text-gray-400 p-3 rounded-full text-2xl transition hover:text-white";
        }

        async function toggleFavorite() {
            if (!currentToken) return alert("Please Login");
            const method = isFavorited ? 'DELETE' : 'POST';
            const url = isFavorited ? `/user/favorites/${currentTrackData.track_id}` : '/user/favorites';
            const body = isFavorited ? null : JSON.stringify({ track_id: currentTrackData.track_id, title: currentTrackData.title, artist: currentTrackData.artist, cover_url: currentTrackData.cover_url, spotify_url: currentTrackData.spotify_url });
            await fetch(url, { method, headers: { 'Authorization': `Bearer ${currentToken}`, 'Content-Type': 'application/json' }, body });
            isFavorited = !isFavorited;
            updateFavBtn();
        }
    </script>
</body>

</html>